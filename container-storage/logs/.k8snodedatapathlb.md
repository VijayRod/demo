```
layer 3 (tcp/udp):
./layer3 lb
./k8s svc lb
./private link (private cluster)

layer 7 (http/https):
./agc
./agic
```

> ## .traffic.k8s

```
# destination is within vnet
azure-cni: Pod > IP direto
kubenet: Pod > Node NAT (IP vNet) > IP (*no double outbound NAT since the destination is a private IP within the same vnet)
```

```
# lb

# client to LB to pod for kubenet and azure-cni during the initial TCP handshake
# O TCP handshake (SYN, SYN-ACK, ACK) é feito entre o cliente e o IP do Load Balancer (frontend IP).
[Client (Internet)]
   |
   |  TCP SYN para IP público (e.g. 20.45.123.10:443) [LB Frontend IP]
   |
[Azure Load Balancer (L4)]
   |
   |  Encaminha para IP privado do Node AKS (e.g. 10.240.0.4) [Backend Pool]
   |
[AKS Node (10.240.0.4)]
   |
   | kube-proxy gere regras iptables > iptables (DNAT para o pod IP)
   |
[Pod (10.240.1.18)]


# client to LB to pod for kubenet and azure-cni after the initial TCP handshake
[Client]
   |
   |  Pacotes TCP (ex: HTTP) > IP público (20.45.123.10:443) [LB Frontend IP]
   |
[Azure Load Balancer (L4)] (*the LB is not in use; it is mentioned here since the public (frontend) IP is associated with it)
   |
   |  Encaminha diretamente (*por sessão mantida)
   |
[AKS Node (10.240.0.4)]
   |
   |  Regras iptables redirecionam
   |
[Pod (10.240.1.18:443)]


# client (within vnet) to azure-cni pod (without LB) is using the pod IP
[Cliente (VM)]
  > [Diretamente para Pod (IP da vNet)]


# client (within vnet) to kubenet pod (without LB) is using the node IP
[Origem Interna (ex: VM na vNet)]
     |
[Não consegue comunicar com IP do pod diretamente]
     |
[Tem de comunicar com o IP do Node AKS ]
     |
[kube-proxy faz DNAT para o Pod]
     |
[Pod (IP interno não roteável)]

# layer 7 ingress controller in AKS without Application Gateway
[Client]
   > [LB]
     > [Node]
       > [Ingress Controller / Proxy (ex: NGINX) (L7)]
         > [Escolhe outro destino (ex: outro pod, outro IP)]
         
# lb supports UDP because its on layer 4
[Client]
   |
   |  UDP packet para IP público do Azure LB (porta 53, por ex.)
   |
[Azure Load Balancer (L4)]
   |
   | Encaminha para IP privado de um Node AKS
   |
[AKS Node]
   |
   | Regras iptables DNAT
   |
[Pod (ex: CoreDNS ou app UDP)]

# snat is only used for outbound, i.e., outbound snat
## azure-cni
[Pod (10.240.1.10)] > [Azure SNAT para IP Público do LB (20.45.123.10)] > [Internet]
## kubenet (double {outbound} snat)
[Pod (IP bridge NAT interno)]
   |
[NAT para IP do Node]
   |
[Azure LB SNAT para IP Público]
   |
[Internet]
```

```
# agic
# tcp handshake + tls, which involves the layer 4 and the beginning of layer 7
# the application gateway (AGIC) does not support UDP, meaning it cannot handle tls termination, routing, rewrites or WAF with UDP. It operates on layer 7, which is higher than tcp
[Client (Internet)]
   |
   |  TCP SYN > IP público do Application Gateway (ex: 20.45.123.10:443)
   |
[Application Gateway (AGIC - Layer 7)] (vNet)
   |
   |  Termina a conexão TLS (SSL offload ou passthrough)
   |
[Regras L7 (Host/Path Based Routing)]
   |
   |  Decide para qual Service/*Ingress ir
   |
[AKS Node (IP privado)]
   |
   |  Envia tráfego para o pod correto via ClusterIP ou diretamente
   |
[Pod (ex: 10.240.1.18)]

# http request, i.e., after the tcp handshake
[Client]
   |
   |  Envia HTTPS > IP público do Application Gateway (ex: 20.45.123.10:443)
   |
[Application Gateway] (vNet)
   |
   |  Decodifica pedido HTTP (L7)
   |  Aplica regras (ex: path-based routing, rewrite, redirect)
   |
azure-cni: [ClusterIP Service] > [Pod (IP da vNet)]
kubenet: [NodePort Service] > [Node (IP da vNet)] > [iptables (DNAT)] > [Pod (IP da bridge)]

# inbound snat
# the app gateway terminates tls and initiates a new conection with the pod, using the private IP of the app gateway as the origin IP
# X-Forwarded-For is used to preserve the original IP
## azure-cni
[Client]
   |
[App Gateway (L7)]
   |
[Pod (IP da vNet)]
## kubenet
[Client]
   |
[App Gateway]
   |
[AKS Node (vNet IP)]
   |
[NAT para Pod (bridge IP)]

# outbound snat from agic pod (itself) to internet e.g. to DNS, metrics, ARM API
azure-cni: Pod (IP vNet) > Azure LB SNAT > Internet
kubenet: Pod (bridge IP) > Node IP (NAT) > Azure LB SNAT > Internet
# outbound snat from application pod to internet
azure-cni: Pod (IP vNet) < AGIC > Pod > Azure LB SNAT > Internet
kubenet: Pod (bridge IP) < AGIC > Pod > Node NAT > Azure LB SNAT > Internet
```

```
# private link (private apiserver fqdn) (private cluster)
# services such as storage accounts are accessible via a private IP
Pod (Azure CNI ou Kubenet)
   > DNS resolve FQDN para IP privado (via Private DNS Zone)
   > Tráfego direto para IP privado do Private Link
   > Sem SNAT

# destination is internet
azure-cni: Pod > Azure LB SNAT
kubenet: Pod > Node SNAT (IP vNet)

# destination is within vnet
azure-cni: Pod > IP direto
kubenet: Pod > Node NAT (IP vNet) > IP (*no double outbound NAT since the destination is a private IP within the same vnet)

# destination is private link (private api server fqdn)
azure-cni: Pod > IP privado
kubenet: Pod > Node NAT (IP vNet) > IP
```
