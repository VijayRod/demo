## cve.trivy

```
# See the section on trivy.k8s.containers
```

```
# cve.trivy.install
aks-nodepool1-98803342-vmss000000:/# apt update -y && apt install snapd -y && export PATH=$PATH:/snap/bin && snap install trivy
```

```
# cve.trivy.install2
# Credits: Andrei Barbu
sudo apt-get install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy
```

```
# cve.trivy.scan

aks-nodepool1-98803342-vmss000000:/# trivy image --ignore-unfixed mcr.microsoft.com/oss/nvidia/k8s-device-plugin:v0.14.5 | grep -E 'HIGH|CRITICAL' | grep fixed
│ golang.org/x/net           │ CVE-2024-45338 │ HIGH     │ fixed  │ v0.18.0           │ 0.33.0
│ github.com/NVIDIA/nvidia-container-toolkit │ CVE-2024-0132  │ CRITICAL │ fixed  │ v1.14.7-0.20240229083338-37b1e37c8f2f │ 1.16.2                           │ nvidia-container-toolkit: Time-of-check Time-of-use (TOCTOU) │

aks-nodepool1-98803342-vmss000001:/# trivy image --ignore-unfixed mcr.microsoft.com/oss/nvidia/k8s-device-plugin:v0.14.5 | grep -E 'HIGH|CRITICAL'
│ stdlib                     │ CVE-2024-24790 │ CRITICAL │        │ v1.20.5           │ 1.21.11, 1.22.4     │ golang: net/netip: Unexpected behavior from Is methods for   │
│                            │ CVE-2023-39325 │ HIGH     │        │                   │ 1.20.10, 1.21.3     │ golang: net/http, x/net/http2: rapid stream resets can cause │
Total: 28 (UNKNOWN: 0, LOW: 0, MEDIUM: 21, HIGH: 5, CRITICAL: 2)

aks-nodepool1-98803342-vmss000000:/# trivy image --ignore-unfixed mcr.microsoft.com/oss/nvidia/k8s-device-plugin:v0.14.5 | grep Total -B 3
mcr.microsoft.com/oss/nvidia/k8s-device-plugin:v0.14.5 (ubuntu 20.04)
=====================================================================
Total: 57 (UNKNOWN: 0, LOW: 24, MEDIUM: 33, HIGH: 0, CRITICAL: 0)
--
usr/bin/config-manager (gobinary)
=================================
Total: 26 (UNKNOWN: 0, LOW: 0, MEDIUM: 20, HIGH: 5, CRITICAL: 1)
--
usr/bin/nvidia-device-plugin (gobinary)
=======================================
Total: 28 (UNKNOWN: 0, LOW: 0, MEDIUM: 21, HIGH: 5, CRITICAL: 2)
```

```
# cve.trivy.scan.out

root@aks-nodepool1-24398294-vmss000000:/# trivy filesystem --exit-code 1 --scanners vuln  --no-progress --timeout 1000s / > /tmp/vuln.txt
2023-10-27T19:24:45.360Z        INFO    Need to update DB
2023-10-27T19:24:45.360Z        INFO    DB Repository: ghcr.io/aquasecurity/trivy-db
2023-10-27T19:24:45.360Z        INFO    Downloading DB...
2023-10-27T19:25:08.937Z        INFO    Vulnerability scanning is enabled
2023-10-27T19:26:08.040Z        INFO    Detected OS: ubuntu
2023-10-27T19:26:08.045Z        INFO    Detecting Ubuntu vulnerabilities...
2023-10-27T19:26:08.646Z        INFO    Number of language-specific files: 3
2023-10-27T19:26:08.646Z        INFO    Detecting bundler vulnerabilities...

root@aks-nodepool1-24398294-vmss000000:/# cat /tmp/vuln.txt | grep HIGH
Total: 1280 (UNKNOWN: 0, LOW: 461, MEDIUM: 720, HIGH: 99, CRITICAL: 0)
│ curl                                  │ CVE-2023-38545   │ HIGH     │ fixed    │ 7.81.0-1ubuntu1.13           │ 7.81.0-1ubuntu1.14        │ heap based buffer overflow in the SOCKS5 proxy handshake     │
│ libcurl3-gnutls                       │ CVE-2023-38545   │ HIGH     │ fixed    │ 7.81.0-1ubuntu1.13           │ 7.

root@aks-nodepool1-24398294-vmss000000:/# cat /tmp/vuln.txt | grep HIGH | grep -v fixed
```

## cve.trivy.k8s.containers

```
# cve.trivy.k8s.container.install

kubectl delete po trivy-scan
# kubectl run trivy-scan --image=aquasec/trivy:latest --restart=Never --command -- trivy image nginx:latest
kubectl run trivy-scan --image=aquasec/trivy:latest --restart=Never --command -- sh -c "trivy image --severity CRITICAL,HIGH nginx:latest && sleep 3600"
kubectl logs trivy-scan
```

```
# cve.trivy.k8s.container.logs - trivy image nginx:latest
kubectl logs trivy-scan
2025-03-06T19:53:40Z    INFO    [vulndb] Need to update DB
2025-03-06T19:53:40Z    INFO    [vulndb] Downloading vulnerability DB...
2025-03-06T19:53:40Z    INFO    [vulndb] Downloading artifact...        repo="mirror.gcr.io/aquasec/trivy-db:2"
22.39 MiB / 60.51 MiB [---------------------->______________________________________] 37.00% ? ...p/s ETA 0s60.51 MiB / 60.51 MiB [-------------------------------------------------] 100.00% 16.31 MiB p/s 3.9s2025-03-06T19:53:50Z        INFO    [vulndb] Artifact successfully downloaded       repo="mirror.gcr.io/aquasec/trivy-db:2"
2025-03-06T19:53:50Z    INFO    [vuln] Vulnerability scanning is enabled
2025-03-06T19:53:50Z    INFO    [secret] Secret scanning is enabled
2025-03-06T19:53:50Z    INFO    [secret] If your scanning is slow, please try '--scanners vuln' to disable secret scanning
2025-03-06T19:53:50Z    INFO    [secret] Please see also https://trivy.dev/v0.60/docs/scanner/secret#recommendationfor faster secret detection
2025-03-06T19:53:56Z    INFO    [javadb] Downloading Java DB...
2025-03-06T19:53:56Z    INFO    [javadb] Downloading artifact...        repo="mirror.gcr.io/aquasec/trivy-java-db:1"
20.00 MiB / 694.19 MiB [->___________________________________________________________] 2.88% ? ...p/s ETA 0s694.19 MiB / 694.19 MiB [------------------------------------------------] 100.00% 20.46 MiB p/s 34s2025-03-06T19:54:31Z    INFO    [javadb] Artifact successfully downloaded   repo="mirror.gcr.io/aquasec/trivy-java-db:1"
2025-03-06T19:54:31Z    INFO    [javadb] Java DB is cached for 3 days. If you want to update the database more frequently, "trivy clean --java-db" command clears the DB cache.
2025-03-06T19:54:33Z    INFO    Detected OS     family="debian" version="12.9"
2025-03-06T19:54:33Z    INFO    [debian] Detecting vulnerabilities...   os_version="12" pkg_num=149
2025-03-06T19:54:33Z    INFO    Number of language-specific files       num=0
2025-03-06T19:54:33Z    WARN    Using severities from other vendors for some vulnerabilities. Read https://trivy.dev/v0.60/docs/scanner/vulnerability#severity-selection for details.

Report Summary
+-----------------------------------------------------------------+
¦           Target           ¦  Type  ¦ Vulnerabilities ¦ Secrets ¦
+----------------------------+--------+-----------------+---------¦
¦ nginx:latest (debian 12.9) ¦ debian ¦       153       ¦    -    ¦
+-----------------------------------------------------------------+
Legend:
- '-': Not scanned
- '0': Clean (no security findings detected)

nginx:latest (debian 12.9)
==========================
Total: 153 (UNKNOWN: 0, LOW: 99, MEDIUM: 43, HIGH: 9, CRITICAL: 2)

+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
¦      Library       ¦    Vulnerability    ¦ Severity ¦    Status    ¦    Installed Version    ¦ Fixed Version ¦                            Title                             ¦
+--------------------+---------------------+----------+--------------+-------------------------+---------------+--------------------------------------------------------------¦
¦ apt                ¦ CVE-2011-3374       ¦ LOW      ¦ affected     ¦ 2.6.1                   ¦               ¦ It was found that apt-key in apt, all versions, do not       ¦
¦                    ¦                     ¦          ¦              ¦                         ¦               ¦ correctly...                                                 ¦
¦                    ¦                     ¦          ¦              ¦                         ¦               ¦ https://avd.aquasec.com/nvd/cve-2011-3374                    ¦
+--------------------+---------------------¦          ¦              +-------------------------+---------------+--------------------------------------------------------------¦
¦ bash               ¦ TEMP-0841856-B18BAF ¦          ¦              ¦ 5.2.15-2+b7             ¦               ¦ [Privilege escalation possible to other user than root]      ¦
¦                    ¦                     ¦          ¦              ¦                         ¦               ¦ https://security-tracker.debian.org/tracker/TEMP-0841856-B1- ¦
¦                    ¦                     ¦          ¦              ¦                         ¦               ¦ 8BAF                                                         ¦
+--------------------+---------------------¦          ¦              +-------------------------+---------------+--------------------------------------------------------------¦
...
```

```
# cve.aks.trivy.severity CRITICAL
kubectl delete po trivy-scan
kubectl run trivy-scan --image=aquasec/trivy:latest --restart=Never --command -- trivy image --severity CRITICAL nginx:latest
kubectl logs trivy-scan

Report Summary
+-----------------------------------------------------------------+
¦           Target           ¦  Type  ¦ Vulnerabilities ¦ Secrets ¦
+----------------------------+--------+-----------------+---------¦
¦ nginx:latest (debian 12.9) ¦ debian ¦        2        ¦    -    ¦
+-----------------------------------------------------------------+
Legend:
- '-': Not scanned
- '0': Clean (no security findings detected)
nginx:latest (debian 12.9)
==========================
Total: 2 (CRITICAL: 2)
...

```

```
# cve.aks.trivy.severity CRITICAL/HIGH.scan pod images in the cluster

# To list the pod images
kubectl get pods -n kube-system -o jsonpath='{range .items[*]}{.spec.containers[*].image}{" "}' | tr " " "\n" | sort -u | uniq |grep ..*
mcr.microsoft.com/oss/kubernetes-csi/azuredisk-csi:v1.30.7
mcr.microsoft.com/oss/kubernetes-csi/azurefile-csi:v1.30.7
mcr.microsoft.com/oss/kubernetes-csi/csi-node-driver-registrar:v2.12.0
...

# To list the pod images - ps
$images = kubectl get pods -n kube-system -o jsonpath="{range .items[*]}{.spec.containers[*].image}{'\n'}{end}"
$images -split "`n" | Sort-Object -Unique | Where-Object {$_ -match "\S"}

# scan pod images in the cluster
kubectl delete po trivy-scan
kubectl run trivy-scan --image=aquasec/trivy:latest --restart=Never --command -- sh -c "trivy image nginx:latest && sleep 3600"
# kubectl logs trivy-scan
kubectl get pods -n kube-system -o jsonpath='{range .items[*]}{.spec.containers[*].image}{" "}' | tr " " "\n" | sort -u | uniq |grep ..* | awk '{print "kubectl exec trivy-scan -- sh -c \"trivy image --severity CRITICAL,HIGH "$1 "\""}' | sh

2025-03-06T18:25:24Z    INFO    [vuln] Vulnerability scanning is enabled
2025-03-06T18:25:24Z    INFO    [secret] Secret scanning is enabled
2025-03-06T18:25:24Z    INFO    [secret] If your scanning is slow, please try '--scanners vuln' to disable secret scanning
2025-03-06T18:25:24Z    INFO    [secret] Please see also https://trivy.dev/v0.60/docs/scanner/secret#recommendation for faster secret detection
2025-03-06T18:25:36Z    INFO    Detected OS     family="alpine" version="3.18.9"
2025-03-06T18:25:36Z    INFO    [alpine] Detecting vulnerabilities...   os_version="3.18" repository="3.18" pkg_num=79
2025-03-06T18:25:36Z    INFO    Number of language-specific files       num=1
2025-03-06T18:25:36Z    INFO    [gobinary] Detecting vulnerabilities...
2025-03-06T18:25:36Z    WARN    Using severities from other vendors for some vulnerabilities. Read https://trivy.dev/v0.60/docs/scanner/vulnerability#severity-selection for details.
Report Summary
+-------------------------------------------------------------------------------------------------------------------+
¦                                   Target                                   ¦   Type   ¦ Vulnerabilities ¦ Secrets ¦
+----------------------------------------------------------------------------+----------+-----------------+---------¦
¦ mcr.microsoft.com/oss/kubernetes-csi/azuredisk-csi:v1.30.7 (alpine 3.18.9) ¦  alpine  ¦        0        ¦    -    ¦
+----------------------------------------------------------------------------+----------+-----------------+---------¦
¦ azurediskplugin                                                            ¦ gobinary ¦        0        ¦    -    ¦
+-------------------------------------------------------------------------------------------------------------------+
Legend:
- '-': Not scanned
- '0': Clean (no security findings detected)
...
```
